Obter localizaÃ§Ã£o dos usuÃ¡rios no WhatsApp Flow

No estado atual do WhatsApp Flows (v3.0), nÃ£o existe nenhum campo automÃ¡tico de localizaÃ§Ã£o no payload criptografado enviado Ã  sua aplicaÃ§Ã£o. O payload do Flow contÃ©m apenas os dados coletados nos componentes de entrada (texto, listas, etc.). De fato, conforme a documentaÃ§Ã£o do 360dialog, os componentes de formulÃ¡rio do Flow incluem inputs como texto, dropdowns, checkboxes, botÃµes e seletores de data â€“ nenhum deles captura automaticamente localizaÃ§Ã£o ou endereÃ§o
docs.360dialog.com
. Em outras palavras, nÃ£o hÃ¡ campo como user_location no JSON do Flow.

TambÃ©m nÃ£o hÃ¡ headers HTTP especiais que informem o IP real do usuÃ¡rio. Todas as requisiÃ§Ãµes dos Flows passam pelos servidores do WhatsApp/Meta, de modo que os cabeÃ§alhos X-Forwarded-For ou similares conterÃ£o apenas o IP da infraestrutura da Meta, nÃ£o do dispositivo cliente. NÃ£o existe, atÃ© onde se sabe, nenhum cabeÃ§alho oculto ou parÃ¢metro de requisiÃ§Ã£o que exponha a localizaÃ§Ã£o ou IP do usuÃ¡rio.

Da mesma forma, nÃ£o hÃ¡ API pÃºblica da Meta/WhatsApp que permita consultar a localizaÃ§Ã£o de um usuÃ¡rio pelo nÃºmero ou ID de WhatsApp. Os APIs oficiais (Cloud API ou Graph API) nÃ£o fornecem esse tipo de dado por motivos de privacidade. O WhatsApp nÃ£o disponibiliza um serviÃ§o que mapeie nÃºmero de telefone para localizaÃ§Ã£o geogrÃ¡fica do usuÃ¡rio. Assim, nÃ£o Ã© possÃ­vel obter cidade/regiÃ£o do cliente sem que ele mesmo forneÃ§a essa informaÃ§Ã£o voluntariamente.

TambÃ©m nÃ£o hÃ¡ â€œpermissÃ£o de localizaÃ§Ã£oâ€ no WhatsApp Flow como em apps mÃ³veis. NÃ£o Ã© possÃ­vel, durante um Flow, acionar um prompt automÃ¡tico de GPS do dispositivo. A Ãºnica forma de obter a localizaÃ§Ã£o do usuÃ¡rio Ã© fazendo com que ele compartilhe manualmente. Por exemplo, o WhatsApp oferece um template de mensagem do tipo â€œRequest Locationâ€. Esse template exibe ao usuÃ¡rio um botÃ£o â€œEnviar localizaÃ§Ã£oâ€ que, quando clicado, abre o mapa do dispositivo e envia sua localizaÃ§Ã£o atual ao negÃ³cio
msgclub.net
. Ou seja, vocÃª pode usar esse template dentro de sua conversa (fora do Flow ou como uma etapa final) para pedir ao usuÃ¡rio que clique e compartilhe sua localizaÃ§Ã£o exata.

Por fim, os webhooks do WhatsApp Business incluem dados de localizaÃ§Ã£o somente se o usuÃ¡rio enviar uma mensagem de localizaÃ§Ã£o. Se vocÃª utilizar um template de â€œSolicitar LocalizaÃ§Ã£oâ€ ou solicitar ao cliente que envie sua localizaÃ§Ã£o, entÃ£o o webhook que chegarÃ¡ ao seu servidor conterÃ¡ um objeto location. Esse objeto incluirÃ¡ latitude e longitude do usuÃ¡rio (e opcionalmente nome/endereÃ§o do local)
developers.liveperson.com
. Por exemplo, em documentaÃ§Ã£o tÃ©cnica vemos que â€œLatitude e Longitude sempre existem na resposta do consumidorâ€ apÃ³s ele compartilhar localizaÃ§Ã£o
developers.liveperson.com
. Quando isso ocorre, os campos messages[0].location.latitude e messages[0].location.longitude estarÃ£o presentes no payload recebido via webhook. A plataforma Twilio, por exemplo, confirma que ao receber uma mensagem de localizaÃ§Ã£o do usuÃ¡rio, o webhook inclui esses parÃ¢metros de latitude/longitude e atÃ© um endereÃ§o (se disponÃ­vel)
twilio.com
.

Resumo das possÃ­veis abordagens: nÃ£o hÃ¡ mÃ©todo automÃ¡tico integrado para obter a cidade/regiÃ£o do usuÃ¡rio no Flow â€“ vocÃª precisa que o prÃ³prio usuÃ¡rio compartilhe a localizaÃ§Ã£o. Em geral, as opÃ§Ãµes sÃ£o: (a) usar um template â€œRequest Locationâ€ para solicitar ao cliente que envie sua localizaÃ§Ã£o
msgclub.net
; (b) instruir o usuÃ¡rio no Flow ou por mensagem subsequente a clicar no Ã­cone de anexo e â€œEnviar LocalizaÃ§Ã£oâ€; (c) entÃ£o tratar o webhook de mensagem recebido, extraindo latitude/longitude dos dados de localizaÃ§Ã£o compartilhados. Fora isso, nÃ£o hÃ¡ header oculto nem API externa que revele a localizaÃ§Ã£o do usuÃ¡rio no WhatsApp Flow.

ReferÃªncias: Segundo a documentaÃ§Ã£o tÃ©cnica, os componentes de entrada do Flow nÃ£o incluem captura de localizaÃ§Ã£o
docs.360dialog.com
. O WhatsApp disponibiliza templates de â€œsolicitar localizaÃ§Ã£oâ€ para o usuÃ¡rio compartilhar sua localizaÃ§Ã£o
msgclub.net
, e quando isso acontece o payload do webhook traz latitude/longitude nas respostas
developers.liveperson.com
twilio.com
. Estas sÃ£o atualmente as Ãºnicas formas oficiais de obter dados de localizaÃ§Ã£o de usuÃ¡rios no WhatsApp Business API.


# ðŸ“ Guia Completo: Captura de LocalizaÃ§Ã£o no WhatsApp Flow

## ðŸš« A Resposta Direta (MÃ¡ NotÃ­cia)

**Infelizmente, NÃƒO Ã© possÃ­vel capturar automaticamente a localizaÃ§Ã£o geogrÃ¡fica real dos usuÃ¡rios no WhatsApp Flow.**

### Por que nÃ£o funciona?

1. **Proxy da Meta**: Todas as requisiÃ§Ãµes passam pelos servidores da Meta/WhatsApp
2. **Privacidade**: WhatsApp nÃ£o expÃµe a localizaÃ§Ã£o do usuÃ¡rio por questÃµes de privacidade
3. **Sem API**: NÃ£o existe API da Meta que forneÃ§a localizaÃ§Ã£o baseada em `wa_id` ou nÃºmero de telefone
4. **Payload vazio**: O payload do Flow nÃ£o contÃ©m dados de localizaÃ§Ã£o do usuÃ¡rio

---

## âŒ O que NÃƒO estÃ¡ disponÃ­vel

ApÃ³s pesquisa extensa na documentaÃ§Ã£o oficial do WhatsApp Flow, confirmei que os seguintes recursos **NÃƒO EXISTEM**:

### 1. Campos de LocalizaÃ§Ã£o no Payload
```json
// âŒ Isso NÃƒO existe no payload do Flow
{
  "version": "3.0",
  "user_locale": "pt_BR",
  "action": "data_exchange",
  "screen": "SCREEN_NAME",
  "data": { ... },
  "flow_token": "token",
  "user_location": { // âŒ NÃƒO EXISTE
    "city": "SÃ£o Paulo",
    "country": "Brasil"
  }
}
```

### 2. Headers HTTP Especiais
```
âŒ x-whatsapp-user-location: NÃƒO EXISTE
âŒ x-meta-user-location: NÃƒO EXISTE
âŒ x-user-country: NÃƒO EXISTE
```

Os Ãºnicos headers disponÃ­veis sÃ£o relacionados Ã  infraestrutura (Railway, Meta, etc.), nÃ£o ao usuÃ¡rio final.

### 3. API de GeolocalizaÃ§Ã£o por NÃºmero
```
âŒ NÃ£o existe endpoint para consultar localizaÃ§Ã£o baseado em wa_id
âŒ NÃ£o existe endpoint para consultar localizaÃ§Ã£o baseado em phone_number
```

### 4. PermissÃ£o de LocalizaÃ§Ã£o no Flow
```
âŒ WhatsApp Flow nÃ£o tem componente "Location Permission Request"
âŒ NÃ£o hÃ¡ forma de solicitar acesso Ã  localizaÃ§Ã£o GPS do dispositivo
```

---

## âœ… O que ESTÃ disponÃ­vel

### 1. **Location Request Message** (SoluÃ§Ã£o Manual)

VocÃª pode pedir para o usuÃ¡rio **compartilhar manualmente** a localizaÃ§Ã£o, mas isso acontece **FORA do Flow**, via mensagem interativa.

#### Como funciona:

```javascript
// 1. Enviar Location Request Message
POST https://graph.facebook.com/v18.0/PHONE_NUMBER_ID/messages

{
  "messaging_product": "whatsapp",
  "recipient_type": "individual",
  "to": "USER_PHONE_NUMBER",
  "type": "interactive",
  "interactive": {
    "type": "location_request_message",
    "body": {
      "text": "Para melhor atendÃª-lo, compartilhe sua localizaÃ§Ã£o:"
    },
    "action": {
      "name": "send_location"
    }
  }
}
```

#### O que vocÃª recebe (Webhook):

```json
{
  "object": "whatsapp_business_account",
  "entry": [{
    "changes": [{
      "value": {
        "messages": [{
          "from": "5511999999999",
          "type": "location",
          "location": {
            "latitude": -23.5505,
            "longitude": -46.6333,
            "address": "Av. Paulista, 1578 - SÃ£o Paulo, SP", // Opcional
            "name": "MASP" // Opcional
          }
        }]
      }
    }]
  }]
}
```

#### âš ï¸ LimitaÃ§Ãµes:
- âŒ NÃ£o funciona **DENTRO** do Flow
- âŒ Requer **aÃ§Ã£o manual** do usuÃ¡rio
- âŒ UsuÃ¡rio pode **recusar** compartilhar
- âŒ Interrompe o fluxo do agendamento

---

### 2. **Country Code do NÃºmero de Telefone** (Workaround Parcial)

O cÃ³digo do paÃ­s do nÃºmero de telefone pode dar uma **aproximaÃ§Ã£o muito grosseira** da localizaÃ§Ã£o.

#### ImplementaÃ§Ã£o:

```javascript
// Extrair cÃ³digo do paÃ­s do wa_id ou phone_number
function getCountryFromPhone(phoneNumber) {
  // Remove caracteres nÃ£o numÃ©ricos
  const cleaned = phoneNumber.replace(/\D/g, '');
  
  // Mapear cÃ³digos de paÃ­s para paÃ­ses
  const countryCodes = {
    '55': { country: 'Brasil', code: 'BR' },
    '1': { country: 'EUA/CanadÃ¡', code: 'US' },
    '44': { country: 'Reino Unido', code: 'GB' },
    '351': { country: 'Portugal', code: 'PT' },
    // ... adicione mais conforme necessÃ¡rio
  };
  
  // Tentar encontrar o cÃ³digo mais longo que corresponda
  for (let len = 3; len >= 1; len--) {
    const code = cleaned.substring(0, len);
    if (countryCodes[code]) {
      return countryCodes[code];
    }
  }
  
  return { country: 'Desconhecido', code: null };
}

// Exemplo de uso no webhook nfm_reply
app.post('/webhook/whatsapp-flow', async (req, res) => {
  // ... cÃ³digo de descriptografia ...
  
  const phoneNumber = req.body.entry[0].changes[0].value.messages[0].from;
  const location = getCountryFromPhone(phoneNumber);
  
  console.log('PaÃ­s estimado:', location.country);
  // Salvar no banco de dados junto com o agendamento
});
```

#### âš ï¸ LimitaÃ§Ãµes:
- âŒ Apenas **paÃ­s**, nÃ£o cidade/regiÃ£o
- âŒ CÃ³digos compartilhados (ex: +1 = EUA e CanadÃ¡)
- âŒ UsuÃ¡rio pode ter nÃºmero de outro paÃ­s
- âŒ NÃ£o reflete localizaÃ§Ã£o **atual**

---

## ðŸŽ¯ SoluÃ§Ãµes PrÃ¡ticas para Seu Caso

Como vocÃª precisa de dados de localizaÃ§Ã£o para KPIs, aqui estÃ£o as **3 melhores abordagens** (em ordem de recomendaÃ§Ã£o):

### **OpÃ§Ã£o 1: Campo Manual no Flow** â­ RECOMENDADO

Adicione um campo no Flow onde o usuÃ¡rio **seleciona a cidade manualmente**.

#### Vantagens:
- âœ… Funciona **DENTRO** do Flow
- âœ… NÃ£o interrompe o agendamento
- âœ… Dados confiÃ¡veis (usuÃ¡rio confirma)
- âœ… FÃ¡cil de implementar

#### ImplementaÃ§Ã£o:

```json
{
  "id": "CITY_SELECTION",
  "title": "Sua LocalizaÃ§Ã£o",
  "terminal": false,
  "data": {
    "cities": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" },
          "description": { "type": "string" }
        }
      },
      "__example__": [
        { "id": "sao_paulo", "title": "SÃ£o Paulo", "description": "SP" },
        { "id": "rio_janeiro", "title": "Rio de Janeiro", "description": "RJ" },
        { "id": "belo_horizonte", "title": "Belo Horizonte", "description": "MG" },
        { "id": "other", "title": "Outra cidade", "description": "Digite manualmente" }
      ]
    }
  },
  "layout": {
    "type": "SingleColumnLayout",
    "children": [
      {
        "type": "TextHeading",
        "text": "De onde vocÃª estÃ¡ nos acessando?"
      },
      {
        "type": "TextCaption",
        "text": "Isso nos ajuda a melhorar nosso serviÃ§o ðŸ˜Š"
      },
      {
        "type": "Form",
        "name": "city_form",
        "children": [
          {
            "type": "Dropdown",
            "name": "selected_city",
            "label": "Selecione sua cidade",
            "required": true,
            "data-source": "${data.cities}"
          }
        ]
      },
      {
        "type": "Footer",
        "label": "Continuar",
        "on-click-action": {
          "name": "data_exchange",
          "payload": {
            "action_type": "SELECT_CITY",
            "selected_city": "${city_form.selected_city}"
          }
        }
      }
    ]
  }
}
```

#### Onde adicionar no routing:
```json
{
  "routing_model": {
    "WELCOME": ["CITY_SELECTION"],  // â† Logo no inÃ­cio
    "CITY_SELECTION": ["SERVICE_SELECTION"],
    "SERVICE_SELECTION": ["DATE_SELECTION"],
    // ... resto do flow
  }
}
```

---

### **OpÃ§Ã£o 2: Capturar Country Code Automaticamente** â­

Use o cÃ³digo do paÃ­s do nÃºmero de telefone para pelo menos saber o paÃ­s de origem.

#### ImplementaÃ§Ã£o no Endpoint:

```javascript
// src/utils/location-helper.js
const countryCodes = {
  '55': { country: 'Brasil', region: 'AmÃ©rica do Sul', code: 'BR', timezone: 'America/Sao_Paulo' },
  '1': { country: 'EUA/CanadÃ¡', region: 'AmÃ©rica do Norte', code: 'US', timezone: 'America/New_York' },
  '351': { country: 'Portugal', region: 'Europa', code: 'PT', timezone: 'Europe/Lisbon' },
  '34': { country: 'Espanha', region: 'Europa', code: 'ES', timezone: 'Europe/Madrid' },
  '44': { country: 'Reino Unido', region: 'Europa', code: 'GB', timezone: 'Europe/London' },
  '52': { country: 'MÃ©xico', region: 'AmÃ©rica do Norte', code: 'MX', timezone: 'America/Mexico_City' },
  '54': { country: 'Argentina', region: 'AmÃ©rica do Sul', code: 'AR', timezone: 'America/Argentina/Buenos_Aires' },
  // Adicione mais conforme necessÃ¡rio
};

function getLocationFromPhone(phoneNumber) {
  const cleaned = phoneNumber.replace(/\D/g, '');
  
  // Tentar cÃ³digos de 3 dÃ­gitos primeiro, depois 2, depois 1
  for (let len = 3; len >= 1; len--) {
    const code = cleaned.substring(0, len);
    if (countryCodes[code]) {
      return {
        ...countryCodes[code],
        phone_code: code,
        full_number: phoneNumber
      };
    }
  }
  
  return {
    country: 'Desconhecido',
    region: 'Desconhecida',
    code: null,
    timezone: 'UTC',
    phone_code: null,
    full_number: phoneNumber
  };
}

module.exports = { getLocationFromPhone };
```

#### Usar no webhook nfm_reply:

```javascript
const { getLocationFromPhone } = require('./utils/location-helper');

app.post('/webhook', async (req, res) => {
  const message = req.body.entry[0].changes[0].value.messages[0];
  
  if (message.type === 'interactive' && message.interactive.type === 'nfm_reply') {
    const phoneNumber = message.from;
    const location = getLocationFromPhone(phoneNumber);
    
    console.log('ðŸ“ LocalizaÃ§Ã£o estimada:', location);
    
    // Salvar no Google Calendar ou banco de dados
    const eventData = {
      ...responseJson,
      estimated_location: location,
      timestamp: new Date().toISOString()
    };
    
    // Criar evento com metadados
    await calendar.events.insert({
      calendarId: CALENDAR_ID,
      resource: {
        summary: `Agendamento - ${responseJson.client_name}`,
        description: `
          PaÃ­s: ${location.country}
          CÃ³digo: ${location.code}
          Telefone: ${phoneNumber}
          ...
        `,
        // ... resto do evento
      }
    });
  }
  
  res.sendStatus(200);
});
```

---

### **OpÃ§Ã£o 3: HÃ­brida (Manual + AutomÃ¡tica)** â­â­

Combine as duas abordagens: capture o country code automaticamente E peÃ§a para o usuÃ¡rio confirmar/especificar a cidade.

#### Fluxo:
1. Capture automaticamente o cÃ³digo do paÃ­s
2. Se Brasil (55), mostre dropdown de cidades brasileiras
3. Se outro paÃ­s, apenas salve o paÃ­s estimado

```javascript
// No endpoint handleInit ou handleSelectService
async function handleInit(decryptedData) {
  const phoneNumber = decryptedData.flow_token || '55...'; // Assumindo que flow_token contÃ©m o nÃºmero
  const location = getLocationFromPhone(phoneNumber);
  
  let cities = [];
  if (location.code === 'BR') {
    // Se for Brasil, oferecer cidades brasileiras
    cities = [
      { id: "sao_paulo", title: "SÃ£o Paulo", description: "SP" },
      { id: "rio_janeiro", title: "Rio de Janeiro", description: "RJ" },
      { id: "brasilia", title: "BrasÃ­lia", description: "DF" },
      { id: "salvador", title: "Salvador", description: "BA" },
      { id: "fortaleza", title: "Fortaleza", description: "CE" },
      { id: "belo_horizonte", title: "Belo Horizonte", description: "MG" },
      { id: "curitiba", title: "Curitiba", description: "PR" },
      { id: "porto_alegre", title: "Porto Alegre", description: "RS" },
      { id: "other", title: "Outra cidade", description: "" }
    ];
  } else {
    // Se outro paÃ­s, nÃ£o precisa perguntar cidade
    cities = [
      { id: location.country.toLowerCase().replace(/\s/g, '_'), title: location.country, description: location.code }
    ];
  }
  
  return {
    version: '3.0',
    screen: location.code === 'BR' ? 'CITY_SELECTION' : 'SERVICE_SELECTION',
    data: {
      estimated_country: location.country,
      estimated_code: location.code,
      cities: cities
    }
  };
}
```

---

## ðŸ“Š Salvando Dados para KPIs

### Estrutura Recomendada no Google Calendar:

```javascript
// Ao criar evento no Calendar
const eventDescription = `
ðŸª AGENDAMENTO
ðŸ“ž Telefone: ${phoneNumber}
ðŸ“ LocalizaÃ§Ã£o Estimada:
   - PaÃ­s: ${location.country}
   - CÃ³digo: ${location.code}
   - RegiÃ£o: ${location.region}
   - Cidade: ${selectedCity || 'NÃ£o informada'}
   
âœ‚ï¸ ServiÃ§o: ${service_name}
ðŸ’° Valor: ${service_price}
ðŸ‘¨â€ðŸ’¼ Barbeiro: ${barber_name}
ðŸ“… Data: ${formatted_date}
ðŸ• HorÃ¡rio: ${selected_time}
ðŸ‘¤ Cliente: ${client_name}
`;

await calendar.events.insert({
  calendarId: CALENDAR_ID,
  resource: {
    summary: `${service_name} - ${client_name}`,
    description: eventDescription,
    start: { dateTime: startTime },
    end: { dateTime: endTime },
    extendedProperties: {
      private: {
        country_code: location.code,
        country_name: location.country,
        city: selectedCity,
        phone_country_code: location.phone_code,
        client_phone: phoneNumber
      }
    }
  }
});
```

### AnÃ¡lise de KPIs:

```javascript
// Script para extrair dados de localizaÃ§Ã£o dos eventos
async function analyzeLocationKPIs() {
  const events = await calendar.events.list({
    calendarId: CALENDAR_ID,
    timeMin: new Date('2025-01-01').toISOString(),
    timeMax: new Date('2025-12-31').toISOString(),
    singleEvents: true
  });
  
  const locationData = {};
  
  events.data.items.forEach(event => {
    const country = event.extendedProperties?.private?.country_name || 'Desconhecido';
    const city = event.extendedProperties?.private?.city || 'NÃ£o informada';
    
    if (!locationData[country]) {
      locationData[country] = { total: 0, cities: {} };
    }
    
    locationData[country].total++;
    
    if (!locationData[country].cities[city]) {
      locationData[country].cities[city] = 0;
    }
    
    locationData[country].cities[city]++;
  });
  
  console.log('ðŸ“Š KPIs de LocalizaÃ§Ã£o:', JSON.stringify(locationData, null, 2));
  
  // Resultado exemplo:
  // {
  //   "Brasil": {
  //     "total": 150,
  //     "cities": {
  //       "SÃ£o Paulo": 80,
  //       "Rio de Janeiro": 45,
  //       "Belo Horizonte": 25
  //     }
  //   }
  // }
}
```

---

## ðŸŽ¯ RecomendaÃ§Ã£o Final para Seu Projeto

Para o seu caso de **agendamento de barbearia**, recomendo:

### **ImplementaÃ§Ã£o Ideal:**

1. **Adicione tela de seleÃ§Ã£o de cidade** no inÃ­cio do Flow (OpÃ§Ã£o 1)
   - Coloque **ANTES** da seleÃ§Ã£o de serviÃ§o
   - Use Dropdown com principais cidades brasileiras
   - Torne **opcional** (nÃ£o required) para nÃ£o criar fricÃ§Ã£o

2. **Capture country code automaticamente** (OpÃ§Ã£o 2)
   - Salve como metadado no Google Calendar
   - Use como fallback se usuÃ¡rio pular a seleÃ§Ã£o de cidade

3. **Analytics Dashboard**
   - Crie script mensal para extrair KPIs de localizaÃ§Ã£o
   - Visualize em planilha ou dashboard simples

### **Prioridades:**

```
Alta Prioridade (implementar agora):
âœ… Adicionar tela de seleÃ§Ã£o de cidade no Flow
âœ… Salvar cidade escolhida no Calendar

MÃ©dia Prioridade (implementar depois):
âš ï¸ Capturar country code automaticamente
âš ï¸ Script de anÃ¡lise de KPIs

Baixa Prioridade (nice-to-have):
ðŸ’¡ Dashboard visual de analytics
ðŸ’¡ ExportaÃ§Ã£o de relatÃ³rios
```

---

## ðŸ“ Exemplo Completo de ImplementaÃ§Ã£o

### 1. Adicionar no Flow JSON (antes de SERVICE_SELECTION):

```json
{
  "id": "CITY_SELECTION",
  "title": "Sua LocalizaÃ§Ã£o",
  "terminal": false,
  "data": {
    "cities": {
      "type": "array",
      "items": { "type": "object" },
      "__example__": [
        { "id": "sp", "title": "SÃ£o Paulo", "description": "SP" },
        { "id": "rj", "title": "Rio de Janeiro", "description": "RJ" }
      ]
    }
  },
  "layout": {
    "type": "SingleColumnLayout",
    "children": [
      {
        "type": "TextHeading",
        "text": "ðŸ“ De onde vocÃª Ã©?"
      },
      {
        "type": "TextBody",
        "text": "Nos ajude a entender melhor nossos clientes!"
      },
      {
        "type": "Form",
        "name": "city_form",
        "children": [
          {
            "type": "Dropdown",
            "name": "city",
            "label": "Cidade",
            "required": false,
            "data-source": "${data.cities}"
          }
        ]
      },
      {
        "type": "Footer",
        "label": "Continuar",
        "on-click-action": {
          "name": "data_exchange",
          "payload": {
            "action_type": "SELECT_CITY",
            "city": "${city_form.city}"
          }
        }
      }
    ]
  }
}
```

### 2. Handler no Endpoint:

```javascript
async function handleSelectCity(decryptedData) {
  const { city } = decryptedData.data;
  
  console.log('ðŸ“ Cidade selecionada:', city || 'NÃ£o informada');
  
  // Retornar para prÃ³xima tela com lista de serviÃ§os
  return {
    version: '3.0',
    screen: 'SERVICE_SELECTION',
    data: {
      selected_city: city,
      services: [
        { id: "corte", title: "Corte Masculino", description: "R$ 45 â€¢ 45 min" },
        // ... seus serviÃ§os
      ]
    }
  };
}
```

### 3. Salvar no Calendar:

```javascript
// No handleSubmitDetails ou no webhook nfm_reply
const phoneNumber = message.from;
const location = getLocationFromPhone(phoneNumber);

await calendar.events.insert({
  calendarId: CALENDAR_ID,
  resource: {
    summary: `${service_name} - ${client_name}`,
    description: `
      ðŸ“ LocalizaÃ§Ã£o:
      - PaÃ­s: ${location.country}
      - Cidade: ${selected_city || 'NÃ£o informada'}
      - Telefone: ${phoneNumber}
      
      ${/* resto da descriÃ§Ã£o */}
    `,
    extendedProperties: {
      private: {
        country_code: location.code,
        city: selected_city,
        phone: phoneNumber,
        timezone: location.timezone
      }
    }
  }
});
```

---

## âœ… Checklist de ImplementaÃ§Ã£o

- [ ] Criar arquivo `location-helper.js` com mapeamento de country codes
- [ ] Adicionar tela `CITY_SELECTION` no Flow JSON
- [ ] Atualizar `routing_model` para incluir nova tela
- [ ] Criar handler `handleSelectCity` no endpoint
- [ ] Modificar `handleInit` para retornar lista de cidades
- [ ] Atualizar criaÃ§Ã£o de eventos no Calendar para incluir localizaÃ§Ã£o
- [ ] Adicionar `extendedProperties` com dados de localizaÃ§Ã£o
- [ ] Testar Flow completo com nova tela
- [ ] Criar script de anÃ¡lise de KPIs
- [ ] Documentar processo de extraÃ§Ã£o de dados

---

## ðŸš€ ConclusÃ£o

Embora nÃ£o seja possÃ­vel capturar automaticamente a localizaÃ§Ã£o GPS real do usuÃ¡rio no WhatsApp Flow, vocÃª pode:

1. âœ… Pedir para o usuÃ¡rio **selecionar a cidade manualmente** (melhor UX)
2. âœ… Capturar o **cÃ³digo do paÃ­s** do nÃºmero de telefone (automÃ¡tico)
3. âœ… Salvar tudo no Google Calendar para **anÃ¡lise de KPIs**

A combinaÃ§Ã£o dessas abordagens vai te dar dados suficientes para entender de onde seus clientes estÃ£o vindo e tomar decisÃµes estratÃ©gicas! ðŸŽ¯

/**
 * location-helper.js
 * Helper para extrair localizaÃ§Ã£o aproximada baseada no cÃ³digo do paÃ­s do telefone
 * 
 * USO:
 * const { getLocationFromPhone } = require('./location-helper');
 * const location = getLocationFromPhone('+5511999999999');
 * console.log(location); // { country: 'Brasil', code: 'BR', ... }
 */

// Mapeamento de cÃ³digos de paÃ­s para informaÃ§Ãµes de localizaÃ§Ã£o
const countryCodes = {
  // AmÃ©rica do Sul
  '55': { 
    country: 'Brasil', 
    region: 'AmÃ©rica do Sul', 
    code: 'BR', 
    timezone: 'America/Sao_Paulo',
    currency: 'BRL'
  },
  '54': { 
    country: 'Argentina', 
    region: 'AmÃ©rica do Sul', 
    code: 'AR', 
    timezone: 'America/Argentina/Buenos_Aires',
    currency: 'ARS'
  },
  '56': { 
    country: 'Chile', 
    region: 'AmÃ©rica do Sul', 
    code: 'CL', 
    timezone: 'America/Santiago',
    currency: 'CLP'
  },
  '57': { 
    country: 'ColÃ´mbia', 
    region: 'AmÃ©rica do Sul', 
    code: 'CO', 
    timezone: 'America/Bogota',
    currency: 'COP'
  },
  '58': { 
    country: 'Venezuela', 
    region: 'AmÃ©rica do Sul', 
    code: 'VE', 
    timezone: 'America/Caracas',
    currency: 'VES'
  },
  '51': { 
    country: 'Peru', 
    region: 'AmÃ©rica do Sul', 
    code: 'PE', 
    timezone: 'America/Lima',
    currency: 'PEN'
  },
  '595': { 
    country: 'Paraguai', 
    region: 'AmÃ©rica do Sul', 
    code: 'PY', 
    timezone: 'America/Asuncion',
    currency: 'PYG'
  },
  '598': { 
    country: 'Uruguai', 
    region: 'AmÃ©rica do Sul', 
    code: 'UY', 
    timezone: 'America/Montevideo',
    currency: 'UYU'
  },
  '593': { 
    country: 'Equador', 
    region: 'AmÃ©rica do Sul', 
    code: 'EC', 
    timezone: 'America/Guayaquil',
    currency: 'USD'
  },
  '591': { 
    country: 'BolÃ­via', 
    region: 'AmÃ©rica do Sul', 
    code: 'BO', 
    timezone: 'America/La_Paz',
    currency: 'BOB'
  },
  
  // AmÃ©rica do Norte
  '1': { 
    country: 'EUA/CanadÃ¡', 
    region: 'AmÃ©rica do Norte', 
    code: 'US', 
    timezone: 'America/New_York',
    currency: 'USD'
  },
  '52': { 
    country: 'MÃ©xico', 
    region: 'AmÃ©rica do Norte', 
    code: 'MX', 
    timezone: 'America/Mexico_City',
    currency: 'MXN'
  },
  
  // AmÃ©rica Central e Caribe
  '53': { 
    country: 'Cuba', 
    region: 'Caribe', 
    code: 'CU', 
    timezone: 'America/Havana',
    currency: 'CUP'
  },
  '507': { 
    country: 'PanamÃ¡', 
    region: 'AmÃ©rica Central', 
    code: 'PA', 
    timezone: 'America/Panama',
    currency: 'PAB'
  },
  '506': { 
    country: 'Costa Rica', 
    region: 'AmÃ©rica Central', 
    code: 'CR', 
    timezone: 'America/Costa_Rica',
    currency: 'CRC'
  },
  
  // Europa
  '351': { 
    country: 'Portugal', 
    region: 'Europa', 
    code: 'PT', 
    timezone: 'Europe/Lisbon',
    currency: 'EUR'
  },
  '34': { 
    country: 'Espanha', 
    region: 'Europa', 
    code: 'ES', 
    timezone: 'Europe/Madrid',
    currency: 'EUR'
  },
  '44': { 
    country: 'Reino Unido', 
    region: 'Europa', 
    code: 'GB', 
    timezone: 'Europe/London',
    currency: 'GBP'
  },
  '33': { 
    country: 'FranÃ§a', 
    region: 'Europa', 
    code: 'FR', 
    timezone: 'Europe/Paris',
    currency: 'EUR'
  },
  '39': { 
    country: 'ItÃ¡lia', 
    region: 'Europa', 
    code: 'IT', 
    timezone: 'Europe/Rome',
    currency: 'EUR'
  },
  '49': { 
    country: 'Alemanha', 
    region: 'Europa', 
    code: 'DE', 
    timezone: 'Europe/Berlin',
    currency: 'EUR'
  },
  '41': { 
    country: 'SuÃ­Ã§a', 
    region: 'Europa', 
    code: 'CH', 
    timezone: 'Europe/Zurich',
    currency: 'CHF'
  },
  '31': { 
    country: 'Holanda', 
    region: 'Europa', 
    code: 'NL', 
    timezone: 'Europe/Amsterdam',
    currency: 'EUR'
  },
  
  // Ãfrica
  '27': { 
    country: 'Ãfrica do Sul', 
    region: 'Ãfrica', 
    code: 'ZA', 
    timezone: 'Africa/Johannesburg',
    currency: 'ZAR'
  },
  '234': { 
    country: 'NigÃ©ria', 
    region: 'Ãfrica', 
    code: 'NG', 
    timezone: 'Africa/Lagos',
    currency: 'NGN'
  },
  '20': { 
    country: 'Egito', 
    region: 'Ãfrica', 
    code: 'EG', 
    timezone: 'Africa/Cairo',
    currency: 'EGP'
  },
  '244': { 
    country: 'Angola', 
    region: 'Ãfrica', 
    code: 'AO', 
    timezone: 'Africa/Luanda',
    currency: 'AOA'
  },
  '258': { 
    country: 'MoÃ§ambique', 
    region: 'Ãfrica', 
    code: 'MZ', 
    timezone: 'Africa/Maputo',
    currency: 'MZN'
  },
  
  // Ãsia
  '86': { 
    country: 'China', 
    region: 'Ãsia', 
    code: 'CN', 
    timezone: 'Asia/Shanghai',
    currency: 'CNY'
  },
  '91': { 
    country: 'Ãndia', 
    region: 'Ãsia', 
    code: 'IN', 
    timezone: 'Asia/Kolkata',
    currency: 'INR'
  },
  '81': { 
    country: 'JapÃ£o', 
    region: 'Ãsia', 
    code: 'JP', 
    timezone: 'Asia/Tokyo',
    currency: 'JPY'
  },
  '82': { 
    country: 'Coreia do Sul', 
    region: 'Ãsia', 
    code: 'KR', 
    timezone: 'Asia/Seoul',
    currency: 'KRW'
  },
  '971': { 
    country: 'Emirados Ãrabes', 
    region: 'Oriente MÃ©dio', 
    code: 'AE', 
    timezone: 'Asia/Dubai',
    currency: 'AED'
  },
  
  // Oceania
  '61': { 
    country: 'AustrÃ¡lia', 
    region: 'Oceania', 
    code: 'AU', 
    timezone: 'Australia/Sydney',
    currency: 'AUD'
  },
  '64': { 
    country: 'Nova ZelÃ¢ndia', 
    region: 'Oceania', 
    code: 'NZ', 
    timezone: 'Pacific/Auckland',
    currency: 'NZD'
  }
};

// Lista de cidades brasileiras principais para dropdown
const brazilianCities = [
  { id: 'sao_paulo', title: 'SÃ£o Paulo', description: 'SP', state: 'SÃ£o Paulo' },
  { id: 'rio_janeiro', title: 'Rio de Janeiro', description: 'RJ', state: 'Rio de Janeiro' },
  { id: 'brasilia', title: 'BrasÃ­lia', description: 'DF', state: 'Distrito Federal' },
  { id: 'salvador', title: 'Salvador', description: 'BA', state: 'Bahia' },
  { id: 'fortaleza', title: 'Fortaleza', description: 'CE', state: 'CearÃ¡' },
  { id: 'belo_horizonte', title: 'Belo Horizonte', description: 'MG', state: 'Minas Gerais' },
  { id: 'manaus', title: 'Manaus', description: 'AM', state: 'Amazonas' },
  { id: 'curitiba', title: 'Curitiba', description: 'PR', state: 'ParanÃ¡' },
  { id: 'recife', title: 'Recife', description: 'PE', state: 'Pernambuco' },
  { id: 'goiania', title: 'GoiÃ¢nia', description: 'GO', state: 'GoiÃ¡s' },
  { id: 'porto_alegre', title: 'Porto Alegre', description: 'RS', state: 'Rio Grande do Sul' },
  { id: 'belem', title: 'BelÃ©m', description: 'PA', state: 'ParÃ¡' },
  { id: 'guarulhos', title: 'Guarulhos', description: 'SP', state: 'SÃ£o Paulo' },
  { id: 'campinas', title: 'Campinas', description: 'SP', state: 'SÃ£o Paulo' },
  { id: 'sao_goncalo', title: 'SÃ£o GonÃ§alo', description: 'RJ', state: 'Rio de Janeiro' },
  { id: 'maceio', title: 'MaceiÃ³', description: 'AL', state: 'Alagoas' },
  { id: 'duque_caxias', title: 'Duque de Caxias', description: 'RJ', state: 'Rio de Janeiro' },
  { id: 'natal', title: 'Natal', description: 'RN', state: 'Rio Grande do Norte' },
  { id: 'teresina', title: 'Teresina', description: 'PI', state: 'PiauÃ­' },
  { id: 'campo_grande', title: 'Campo Grande', description: 'MS', state: 'Mato Grosso do Sul' },
  { id: 'other', title: 'Outra cidade', description: '', state: '' }
];

/**
 * Extrai informaÃ§Ãµes de localizaÃ§Ã£o baseado no nÃºmero de telefone
 * @param {string} phoneNumber - NÃºmero de telefone com ou sem formataÃ§Ã£o
 * @returns {Object} Objeto com informaÃ§Ãµes de localizaÃ§Ã£o
 */
function getLocationFromPhone(phoneNumber) {
  if (!phoneNumber) {
    return {
      country: 'Desconhecido',
      region: 'Desconhecida',
      code: null,
      timezone: 'UTC',
      currency: null,
      phone_code: null,
      full_number: null,
      valid: false
    };
  }
  
  // Remove todos os caracteres nÃ£o numÃ©ricos
  const cleaned = phoneNumber.replace(/\D/g, '');
  
  // Remove o + inicial se presente
  const numberWithoutPlus = cleaned.startsWith('+') ? cleaned.substring(1) : cleaned;
  
  // Tentar encontrar o cÃ³digo mais longo que corresponda (mÃ¡ximo 3 dÃ­gitos)
  for (let len = 3; len >= 1; len--) {
    const code = numberWithoutPlus.substring(0, len);
    if (countryCodes[code]) {
      return {
        ...countryCodes[code],
        phone_code: code,
        full_number: phoneNumber,
        valid: true,
        is_brazil: code === '55'
      };
    }
  }
  
  // Se nÃ£o encontrar, retorna desconhecido
  return {
    country: 'Desconhecido',
    region: 'Desconhecida',
    code: null,
    timezone: 'UTC',
    currency: null,
    phone_code: null,
    full_number: phoneNumber,
    valid: false,
    is_brazil: false
  };
}

/**
 * Retorna lista de cidades brasileiras para usar no dropdown
 * @returns {Array} Lista de cidades formatada para WhatsApp Flow
 */
function getBrazilianCities() {
  return brazilianCities;
}

/**
 * Formata informaÃ§Ãµes de localizaÃ§Ã£o para descriÃ§Ã£o de evento
 * @param {Object} location - Objeto de localizaÃ§Ã£o retornado por getLocationFromPhone
 * @param {string} selectedCity - Cidade selecionada pelo usuÃ¡rio (opcional)
 * @returns {string} String formatada para descriÃ§Ã£o
 */
function formatLocationForDescription(location, selectedCity = null) {
  if (!location.valid) {
    return 'ðŸ“ LocalizaÃ§Ã£o: Desconhecida';
  }
  
  let description = `ðŸ“ LocalizaÃ§Ã£o:
   - PaÃ­s: ${location.country}
   - RegiÃ£o: ${location.region}
   - CÃ³digo: ${location.code}`;
  
  if (selectedCity) {
    const cityInfo = brazilianCities.find(c => c.id === selectedCity);
    if (cityInfo) {
      description += `
   - Cidade: ${cityInfo.title} (${cityInfo.description})`;
    } else {
      description += `
   - Cidade: ${selectedCity}`;
    }
  }
  
  description += `
   - Timezone: ${location.timezone}
   - Moeda: ${location.currency}`;
  
  return description;
}

/**
 * Cria objeto extendedProperties para Google Calendar
 * @param {Object} location - Objeto de localizaÃ§Ã£o
 * @param {string} selectedCity - Cidade selecionada (opcional)
 * @param {string} phoneNumber - NÃºmero de telefone do cliente
 * @returns {Object} Objeto formatado para extendedProperties
 */
function getCalendarExtendedProperties(location, selectedCity, phoneNumber) {
  return {
    private: {
      country_code: location.code || 'UNKNOWN',
      country_name: location.country || 'Desconhecido',
      region: location.region || 'Desconhecida',
      timezone: location.timezone || 'UTC',
      currency: location.currency || null,
      city_id: selectedCity || null,
      city_name: brazilianCities.find(c => c.id === selectedCity)?.title || null,
      phone_country_code: location.phone_code || null,
      client_phone: phoneNumber,
      location_valid: location.valid.toString()
    }
  };
}

/**
 * Agrupa dados de localizaÃ§Ã£o para anÃ¡lise de KPIs
 * @param {Array} events - Lista de eventos do Google Calendar
 * @returns {Object} Dados agregados por paÃ­s e cidade
 */
function aggregateLocationData(events) {
  const locationData = {
    total_events: 0,
    by_country: {},
    by_city: {},
    unknown: 0
  };
  
  events.forEach(event => {
    locationData.total_events++;
    
    const props = event.extendedProperties?.private;
    if (!props || props.location_valid !== 'true') {
      locationData.unknown++;
      return;
    }
    
    const country = props.country_name || 'Desconhecido';
    const city = props.city_name || 'NÃ£o informada';
    
    // Agregar por paÃ­s
    if (!locationData.by_country[country]) {
      locationData.by_country[country] = {
        total: 0,
        code: props.country_code,
        region: props.region,
        cities: {}
      };
    }
    locationData.by_country[country].total++;
    
    // Agregar por cidade dentro do paÃ­s
    if (!locationData.by_country[country].cities[city]) {
      locationData.by_country[country].cities[city] = 0;
    }
    locationData.by_country[country].cities[city]++;
    
    // Agregar globalmente por cidade
    if (!locationData.by_city[city]) {
      locationData.by_city[city] = {
        total: 0,
        country: country
      };
    }
    locationData.by_city[city].total++;
  });
  
  return locationData;
}

/**
 * Gera relatÃ³rio formatado de KPIs de localizaÃ§Ã£o
 * @param {Object} locationData - Dados agregados de aggregateLocationData
 * @returns {string} RelatÃ³rio formatado
 */
function generateLocationReport(locationData) {
  let report = `ðŸ“Š RELATÃ“RIO DE LOCALIZAÃ‡ÃƒO\n`;
  report += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
  report += `Total de agendamentos: ${locationData.total_events}\n`;
  report += `LocalizaÃ§Ãµes desconhecidas: ${locationData.unknown}\n\n`;
  
  report += `ðŸ“ POR PAÃS:\n`;
  report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
  
  // Ordenar paÃ­ses por total (maior para menor)
  const sortedCountries = Object.entries(locationData.by_country)
    .sort((a, b) => b[1].total - a[1].total);
  
  sortedCountries.forEach(([country, data]) => {
    const percentage = ((data.total / locationData.total_events) * 100).toFixed(1);
    report += `\n${country} (${data.code}): ${data.total} agendamentos (${percentage}%)\n`;
    
    // Ordenar cidades dentro do paÃ­s
    const sortedCities = Object.entries(data.cities)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5); // Top 5 cidades
    
    if (sortedCities.length > 0) {
      report += `  Principais cidades:\n`;
      sortedCities.forEach(([city, count]) => {
        const cityPercentage = ((count / data.total) * 100).toFixed(1);
        report += `    â€¢ ${city}: ${count} (${cityPercentage}%)\n`;
      });
    }
  });
  
  return report;
}

// Exportar funÃ§Ãµes
module.exports = {
  getLocationFromPhone,
  getBrazilianCities,
  formatLocationForDescription,
  getCalendarExtendedProperties,
  aggregateLocationData,
  generateLocationReport,
  countryCodes // Exportar para referÃªncia
};


/**
 * Exemplo Completo: Como usar o location-helper.js no seu endpoint
 * 
 * Este arquivo mostra como integrar a captura de localizaÃ§Ã£o no seu endpoint
 * atual de WhatsApp Flow
 */

const express = require('express');
const { getLocationFromPhone, getBrazilianCities, formatLocationForDescription, getCalendarExtendedProperties } = require('./location-helper');
const { google } = require('googleapis');

// ============================================
// EXEMPLO 1: Handler INIT com seleÃ§Ã£o de cidade
// ============================================

async function handleInit(decryptedData) {
  console.log('ðŸš€ INIT - Iniciando Flow');
  
  // Tentar obter nÃºmero de telefone do flow_token ou de outra fonte
  const phoneNumber = decryptedData.flow_token; // Ou de onde vocÃª obtÃ©m o nÃºmero
  
  // Detectar localizaÃ§Ã£o automaticamente
  const location = getLocationFromPhone(phoneNumber);
  console.log('ðŸ“ LocalizaÃ§Ã£o detectada:', location);
  
  // Se for Brasil, oferecer lista de cidades
  let cities = [];
  if (location.is_brazil) {
    cities = getBrazilianCities();
    console.log('ðŸ‡§ðŸ‡· Ã‰ do Brasil! Oferecendo lista de cidades brasileiras');
  } else {
    // Se outro paÃ­s, criar cidade Ãºnica com o nome do paÃ­s
    cities = [
      {
        id: location.code?.toLowerCase() || 'other',
        title: location.country,
        description: location.code || ''
      }
    ];
    console.log(`ðŸŒ PaÃ­s: ${location.country} - Sem lista de cidades`);
  }
  
  return {
    version: '3.0',
    screen: 'CITY_SELECTION', // Vai para tela de seleÃ§Ã£o de cidade
    data: {
      estimated_country: location.country,
      estimated_code: location.code,
      is_brazil: location.is_brazil,
      cities: cities
    }
  };
}

// ============================================
// EXEMPLO 2: Handler SELECT_CITY
// ============================================

async function handleSelectCity(decryptedData) {
  const { city } = decryptedData.data;
  
  console.log('ðŸ“ SELECT_CITY - Cidade escolhida:', city || 'NÃ£o informada');
  
  // Buscar serviÃ§os disponÃ­veis
  const services = [
    { id: 'corte_masculino', title: 'Corte Masculino', description: 'R$ 45 â€¢ 45 min' },
    { id: 'barba', title: 'Barba', description: 'R$ 30 â€¢ 30 min' },
    { id: 'corte_barba', title: 'Corte + Barba', description: 'R$ 65 â€¢ 60 min' }
  ];
  
  return {
    version: '3.0',
    screen: 'SERVICE_SELECTION',
    data: {
      selected_city: city, // Passa a cidade para as prÃ³ximas telas
      services: services
    }
  };
}

// ============================================
// EXEMPLO 3: Handler SUBMIT_DETAILS com localizaÃ§Ã£o
// ============================================

async function handleSubmitDetails(decryptedData) {
  const { 
    selected_service, 
    selected_date, 
    selected_barber, 
    selected_time,
    client_name, 
    client_phone, 
    client_email, 
    notes,
    service_name, 
    service_price, 
    barber_name, 
    formatted_date,
    selected_city // â† Cidade selecionada vindo das telas anteriores
  } = decryptedData.data;
  
  // Gerar booking_id
  const booking_id = `AGD-${Math.floor(Math.random() * 999999)}`;
  
  // Detectar localizaÃ§Ã£o do nÃºmero do cliente
  const location = getLocationFromPhone(client_phone);
  
  console.log('ðŸ“¤ SUBMIT_DETAILS');
  console.log('ðŸ“ LocalizaÃ§Ã£o:', location);
  console.log('ðŸ™ï¸ Cidade selecionada:', selected_city);
  
  return {
    version: '3.0',
    screen: 'CONFIRMATION_PREP',
    data: {
      booking_id,
      selected_service,
      selected_date,
      selected_barber,
      selected_time,
      client_name,
      client_phone,
      client_email: client_email || '',
      notes: notes || '',
      service_name,
      service_price,
      barber_name,
      formatted_date,
      selected_city, // Inclui cidade na resposta
      estimated_country: location.country // Inclui paÃ­s estimado
    }
  };
}

// ============================================
// EXEMPLO 4: Webhook nfm_reply - Salvar no Calendar com localizaÃ§Ã£o
// ============================================

async function handleWebhookNfmReply(req, res) {
  const message = req.body.entry?.[0]?.changes?.[0]?.value?.messages?.[0];
  
  if (!message || message.type !== 'interactive' || message.interactive.type !== 'nfm_reply') {
    return res.sendStatus(200);
  }
  
  const responseJson = JSON.parse(message.interactive.nfm_reply.response_json);
  const phoneNumber = message.from;
  
  console.log('âœ… Flow concluÃ­do! Criando agendamento...');
  console.log('ðŸ“± Telefone:', phoneNumber);
  
  // Detectar localizaÃ§Ã£o automaticamente do nÃºmero
  const location = getLocationFromPhone(phoneNumber);
  console.log('ðŸ“ LocalizaÃ§Ã£o detectada:', location);
  
  // Extrair cidade selecionada do response_json
  const selectedCity = responseJson.selected_city || null;
  
  // Formatar descriÃ§Ã£o com localizaÃ§Ã£o
  const locationDescription = formatLocationForDescription(location, selectedCity);
  
  // Criar descriÃ§Ã£o completa do evento
  const eventDescription = `
ðŸª AGENDAMENTO DE BARBEARIA

${locationDescription}

âœ‚ï¸ ServiÃ§o: ${responseJson.service_name}
ðŸ’° Valor: ${responseJson.service_price}
ðŸ‘¨â€ðŸ’¼ Barbeiro: ${responseJson.barber_name}
ðŸ“… Data: ${responseJson.formatted_date}
ðŸ• HorÃ¡rio: ${responseJson.selected_time}

ðŸ‘¤ DADOS DO CLIENTE
   - Nome: ${responseJson.client_name}
   - Telefone: ${phoneNumber}
   - Email: ${responseJson.client_email || 'NÃ£o informado'}

ðŸ“ ObservaÃ§Ãµes: ${responseJson.notes || 'Nenhuma'}

ðŸ”– CÃ³digo do agendamento: ${responseJson.booking_id}
`;
  
  // Configurar Google Calendar
  const auth = new google.auth.GoogleAuth({
    credentials: JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_KEY),
    scopes: ['https://www.googleapis.com/auth/calendar']
  });
  
  const calendar = google.calendar({ version: 'v3', auth });
  
  // Calcular horÃ¡rios
  const [hour, minute] = responseJson.selected_time.split(':');
  const startDateTime = new Date(responseJson.selected_date);
  startDateTime.setHours(parseInt(hour), parseInt(minute), 0);
  
  const endDateTime = new Date(startDateTime);
  endDateTime.setMinutes(endDateTime.getMinutes() + 45); // DuraÃ§Ã£o padrÃ£o
  
  try {
    // Criar evento no Calendar com dados de localizaÃ§Ã£o
    const event = await calendar.events.insert({
      calendarId: process.env.GOOGLE_CALENDAR_EMAIL,
      requestBody: {
        summary: `${responseJson.service_name} - ${responseJson.client_name}`,
        description: eventDescription,
        start: {
          dateTime: startDateTime.toISOString(),
          timeZone: location.timezone || 'America/Sao_Paulo'
        },
        end: {
          dateTime: endDateTime.toISOString(),
          timeZone: location.timezone || 'America/Sao_Paulo'
        },
        attendees: [
          { email: responseJson.client_email }
        ],
        reminders: {
          useDefault: false,
          overrides: [
            { method: 'email', minutes: 24 * 60 }, // 1 dia antes
            { method: 'popup', minutes: 60 }       // 1 hora antes
          ]
        },
        // âœ¨ IMPORTANTE: Salvar dados estruturados para KPIs
        extendedProperties: getCalendarExtendedProperties(
          location, 
          selectedCity, 
          phoneNumber
        )
      }
    });
    
    console.log('âœ… Evento criado no Calendar:', event.data.id);
    console.log('ðŸ“Š Dados de localizaÃ§Ã£o salvos para KPIs');
    
  } catch (error) {
    console.error('âŒ Erro ao criar evento:', error);
  }
  
  res.sendStatus(200);
}

// ============================================
// EXEMPLO 5: Script para AnÃ¡lise de KPIs
// ============================================

const { aggregateLocationData, generateLocationReport } = require('./location-helper');

async function analyzeLocationKPIs() {
  console.log('ðŸ“Š Analisando KPIs de LocalizaÃ§Ã£o...\n');
  
  // Configurar Google Calendar
  const auth = new google.auth.GoogleAuth({
    credentials: JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_KEY),
    scopes: ['https://www.googleapis.com/auth/calendar']
  });
  
  const calendar = google.calendar({ version: 'v3', auth });
  
  // Buscar eventos dos Ãºltimos 30 dias
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  try {
    const response = await calendar.events.list({
      calendarId: process.env.GOOGLE_CALENDAR_EMAIL,
      timeMin: thirtyDaysAgo.toISOString(),
      timeMax: new Date().toISOString(),
      singleEvents: true,
      orderBy: 'startTime'
    });
    
    const events = response.data.items || [];
    console.log(`ðŸ“… Total de eventos encontrados: ${events.length}\n`);
    
    // Agregar dados de localizaÃ§Ã£o
    const locationData = aggregateLocationData(events);
    
    // Gerar relatÃ³rio
    const report = generateLocationReport(locationData);
    console.log(report);
    
    // TambÃ©m pode salvar em arquivo ou enviar por email
    const fs = require('fs');
    const reportFilename = `location_report_${new Date().toISOString().split('T')[0]}.txt`;
    fs.writeFileSync(reportFilename, report);
    console.log(`\nðŸ’¾ RelatÃ³rio salvo em: ${reportFilename}`);
    
    // Retornar dados brutos para processamento adicional
    return locationData;
    
  } catch (error) {
    console.error('âŒ Erro ao buscar eventos:', error);
    throw error;
  }
}

// ============================================
// EXEMPLO 6: Endpoint para Dashboard de KPIs (opcional)
// ============================================

// Adicione este endpoint ao seu Express app para acessar via web
app.get('/api/location-kpis', async (req, res) => {
  try {
    const locationData = await analyzeLocationKPIs();
    
    res.json({
      success: true,
      data: locationData,
      generated_at: new Date().toISOString()
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ============================================
// EXEMPLO 7: Teste RÃ¡pido do Location Helper
// ============================================

function testLocationHelper() {
  console.log('ðŸ§ª Testando Location Helper...\n');
  
  const testNumbers = [
    '+55 11 99999-9999',  // Brasil
    '+1 555 123 4567',     // EUA
    '+351 912 345 678',    // Portugal
    '+34 612 345 678',     // Espanha
    '5511999999999',       // Brasil sem formataÃ§Ã£o
    'invalid'              // InvÃ¡lido
  ];
  
  testNumbers.forEach(number => {
    const location = getLocationFromPhone(number);
    console.log(`ðŸ“ž ${number}`);
    console.log(`   PaÃ­s: ${location.country}`);
    console.log(`   CÃ³digo: ${location.code || 'N/A'}`);
    console.log(`   VÃ¡lido: ${location.valid ? 'âœ…' : 'âŒ'}`);
    console.log('');
  });
  
  console.log('ðŸ‡§ðŸ‡· Cidades brasileiras disponÃ­veis:', getBrazilianCities().length);
}

// ============================================
// EXEMPLO 8: IntegraÃ§Ã£o Completa no Main Router
// ============================================

app.post('/webhook/whatsapp-flow', async (req, res) => {
  try {
    // ... seu cÃ³digo de descriptografia ...
    
    const { action, screen, data } = decryptedData;
    
    let response;
    
    switch (action) {
      case 'INIT':
        response = await handleInit(decryptedData);
        break;
        
      case 'data_exchange':
        const actionType = data.action_type;
        
        if (actionType === 'SELECT_CITY') {
          response = await handleSelectCity(decryptedData);
        } else if (actionType === 'SELECT_SERVICE') {
          // ... seu handler existente
        } else if (actionType === 'SUBMIT_DETAILS') {
          response = await handleSubmitDetails(decryptedData);
        }
        // ... outros handlers
        break;
        
      default:
        response = { version: '3.0', data: {} };
    }
    
    // ... seu cÃ³digo de criptografia e resposta ...
    
  } catch (error) {
    console.error('Erro:', error);
    res.sendStatus(500);
  }
});

// Webhook para mensagens (nfm_reply)
app.post('/webhook', async (req, res) => {
  const message = req.body.entry?.[0]?.changes?.[0]?.value?.messages?.[0];
  
  if (message?.type === 'interactive' && message.interactive.type === 'nfm_reply') {
    await handleWebhookNfmReply(req, res);
  } else {
    res.sendStatus(200);
  }
});

// ============================================
// EXPORTAR FUNÃ‡Ã•ES
// ============================================

module.exports = {
  handleInit,
  handleSelectCity,
  handleSubmitDetails,
  handleWebhookNfmReply,
  analyzeLocationKPIs,
  testLocationHelper
};

// ============================================
// EXECUTAR TESTE (se rodar diretamente)
// ============================================

if (require.main === module) {
  console.log('ðŸš€ Executando testes...\n');
  testLocationHelper();
}

{
  "version": "7.3",
  "data_api_version": "3.0",
  "routing_model": {
    "WELCOME": ["CITY_SELECTION"],
    "CITY_SELECTION": ["SERVICE_SELECTION"],
    "SERVICE_SELECTION": ["DATE_SELECTION"],
    "DATE_SELECTION": ["BARBER_SELECTION"],
    "BARBER_SELECTION": ["TIME_SELECTION"],
    "TIME_SELECTION": ["DETAILS"],
    "DETAILS": ["CONFIRMATION"],
    "CONFIRMATION": []
  },
  "screens": [
    {
      "id": "WELCOME",
      "title": "Bem-vindo",
      "terminal": false,
      "data": {},
      "layout": {
        "type": "SingleColumnLayout",
        "children": [
          {
            "type": "Image",
            "src": "https://images.unsplash.com/photo-1585747860715-2ba37e788b70?w=800&auto=format&fit=crop",
            "height": 180,
            "scale-type": "cover",
            "aspect-ratio": 2.5,
            "alt-text": "Barbearia - Ambiente moderno"
          },
          {
            "type": "TextHeading",
            "text": "ðŸ’ˆ Agende seu horÃ¡rio"
          },
          {
            "type": "TextBody",
            "text": "OlÃ¡! Agende seu atendimento de forma rÃ¡pida e prÃ¡tica. Em poucos passos vocÃª escolhe o serviÃ§o, data, barbeiro e horÃ¡rio."
          },
          {
            "type": "TextCaption",
            "text": "â±ï¸ Leva menos de 1 minuto"
          },
          {
            "type": "Footer",
            "label": "ComeÃ§ar agendamento",
            "on-click-action": {
              "name": "data_exchange",
              "payload": {
                "action_type": "INIT"
              }
            }
          }
        ]
      }
    },
    {
      "id": "CITY_SELECTION",
      "title": "LocalizaÃ§Ã£o",
      "terminal": false,
      "data": {
        "estimated_country": {
          "type": "string",
          "__example__": "Brasil"
        },
        "estimated_code": {
          "type": "string",
          "__example__": "BR"
        },
        "is_brazil": {
          "type": "boolean",
          "__example__": true
        },
        "cities": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "title": { "type": "string" },
              "description": { "type": "string" }
            }
          },
          "__example__": [
            { "id": "sao_paulo", "title": "SÃ£o Paulo", "description": "SP" },
            { "id": "rio_janeiro", "title": "Rio de Janeiro", "description": "RJ" },
            { "id": "belo_horizonte", "title": "Belo Horizonte", "description": "MG" },
            { "id": "other", "title": "Outra cidade", "description": "" }
          ]
        }
      },
      "layout": {
        "type": "SingleColumnLayout",
        "children": [
          {
            "type": "TextHeading",
            "text": "ðŸ“ De onde vocÃª estÃ¡ nos acessando?"
          },
          {
            "type": "TextBody",
            "text": "Detectamos que vocÃª estÃ¡ no ${data.estimated_country}. Nos ajude a melhorar nosso serviÃ§o informando sua cidade!"
          },
          {
            "type": "TextCaption",
            "text": "âœ¨ Isso nÃ£o afeta seu agendamento"
          },
          {
            "type": "Form",
            "name": "city_form",
            "children": [
              {
                "type": "Dropdown",
                "name": "selected_city",
                "label": "Selecione sua cidade",
                "required": false,
                "data-source": "${data.cities}"
              }
            ]
          },
          {
            "type": "Footer",
            "label": "Continuar",
            "on-click-action": {
              "name": "data_exchange",
              "payload": {
                "action_type": "SELECT_CITY",
                "selected_city": "${city_form.selected_city}",
                "estimated_country": "${data.estimated_country}",
                "estimated_code": "${data.estimated_code}"
              }
            }
          }
        ]
      }
    },
    {
      "id": "SERVICE_SELECTION",
      "title": "Escolha o ServiÃ§o",
      "terminal": false,
      "data": {
        "selected_city": {
          "type": "string",
          "__example__": "sao_paulo"
        },
        "services": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "title": { "type": "string" },
              "description": { "type": "string" }
            }
          },
          "__example__": [
            { "id": "corte_masculino", "title": "Corte Masculino", "description": "R$ 45 â€¢ 45 min" }
          ]
        }
      },
      "layout": {
        "type": "SingleColumnLayout",
        "children": [
          {
            "type": "TextHeading",
            "text": "Qual serviÃ§o vocÃª deseja?"
          },
          {
            "type": "TextCaption",
            "text": "Selecione uma opÃ§Ã£o abaixo"
          },
          {
            "type": "Form",
            "name": "service_form",
            "children": [
              {
                "type": "RadioButtonsGroup",
                "name": "selected_service",
                "label": "ServiÃ§os disponÃ­veis",
                "required": true,
                "data-source": "${data.services}"
              }
            ]
          },
          {
            "type": "Footer",
            "label": "Escolher data",
            "on-click-action": {
              "name": "data_exchange",
              "payload": {
                "action_type": "SELECT_SERVICE",
                "selected_service": "${service_form.selected_service}",
                "selected_city": "${data.selected_city}"
              }
            }
          }
        ]
      }
    },
    {
      "id": "DATE_SELECTION",
      "title": "Escolha a Data",
      "terminal": false,
      "data": {
        "selected_city": {
          "type": "string",
          "__example__": "sao_paulo"
        },
        "selected_service": {
          "type": "string",
          "__example__": "corte_masculino"
        },
        "service_name": {
          "type": "string",
          "__example__": "Corte Masculino"
        },
        "service_price": {
          "type": "string",
          "__example__": "R$ 45"
        },
        "min_date": {
          "type": "string",
          "__example__": "2025-01-01"
        },
        "max_date": {
          "type": "string",
          "__example__": "2025-12-31"
        },
        "unavailable_dates": {
          "type": "array",
          "items": { "type": "string" },
          "__example__": ["2025-12-25"]
        }
      },
      "layout": {
        "type": "SingleColumnLayout",
        "children": [
          {
            "type": "TextHeading",
            "text": "Quando vocÃª quer vir?"
          },
          {
            "type": "TextBody",
            "text": "${data.service_name}"
          },
          {
            "type": "TextCaption",
            "text": "${data.service_price}"
          },
          {
            "type": "Form",
            "name": "date_form",
            "children": [
              {
                "type": "DatePicker",
                "name": "selected_date",
                "label": "Selecione a data",
                "required": true,
                "min-date": "${data.min_date}",
                "max-date": "${data.max_date}",
                "unavailable-dates": "${data.unavailable_dates}"
              }
            ]
          },
          {
            "type": "Footer",
            "label": "Ver barbeiros disponÃ­veis",
            "on-click-action": {
              "name": "data_exchange",
              "payload": {
                "action_type": "SELECT_DATE",
                "selected_city": "${data.selected_city}",
                "selected_service": "${data.selected_service}",
                "selected_date": "${date_form.selected_date}"
              }
            }
          }
        ]
      }
    },
    {
      "id": "BARBER_SELECTION",
      "title": "Escolha o Barbeiro",
      "terminal": false,
      "data": {
        "selected_city": {
          "type": "string",
          "__example__": "sao_paulo"
        },
        "selected_service": {
          "type": "string",
          "__example__": "corte_masculino"
        },
        "selected_date": {
          "type": "string",
          "__example__": "2025-01-15"
        },
        "service_name": {
          "type": "string",
          "__example__": "Corte Masculino"
        },
        "service_price": {
          "type": "string",
          "__example__": "R$ 45"
        },
        "formatted_date": {
          "type": "string",
          "__example__": "15/01/2025"
        },
        "barbers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "title": { "type": "string" },
              "description": { "type": "string" }
            }
          },
          "__example__": [
            { "id": "joao", "title": "JoÃ£o Silva", "description": "DisponÃ­vel" }
          ]
        }
      },
      "layout": {
        "type": "SingleColumnLayout",
        "children": [
          {
            "type": "TextHeading",
            "text": "Quem vai te atender?"
          },
          {
            "type": "TextCaption",
            "text": "${data.service_name}"
          },
          {
            "type": "TextCaption",
            "text": "${data.formatted_date}"
          },
          {
            "type": "Form",
            "name": "barber_form",
            "children": [
              {
                "type": "RadioButtonsGroup",
                "name": "selected_barber",
                "label": "Barbeiros disponÃ­veis",
                "required": true,
                "data-source": "${data.barbers}"
              }
            ]
          },
          {
            "type": "Footer",
            "label": "Ver horÃ¡rios",
            "on-click-action": {
              "name": "data_exchange",
              "payload": {
                "action_type": "SELECT_BARBER",
                "selected_city": "${data.selected_city}",
                "selected_service": "${data.selected_service}",
                "selected_date": "${data.selected_date}",
                "selected_barber": "${barber_form.selected_barber}"
              }
            }
          }
        ]
      }
    },
    {
      "id": "TIME_SELECTION",
      "title": "Escolha o HorÃ¡rio",
      "terminal": false,
      "data": {
        "selected_city": {
          "type": "string",
          "__example__": "sao_paulo"
        },
        "selected_service": {
          "type": "string",
          "__example__": "corte_masculino"
        },
        "selected_date": {
          "type": "string",
          "__example__": "2025-01-15"
        },
        "selected_barber": {
          "type": "string",
          "__example__": "joao"
        },
        "service_name": {
          "type": "string",
          "__example__": "Corte Masculino"
        },
        "service_price": {
          "type": "string",
          "__example__": "R$ 45"
        },
        "barber_name": {
          "type": "string",
          "__example__": "JoÃ£o Silva"
        },
        "formatted_date": {
          "type": "string",
          "__example__": "15/01/2025"
        },
        "available_times": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "title": { "type": "string" },
              "description": { "type": "string" }
            }
          },
          "__example__": [
            { "id": "09:00", "title": "09:00", "description": "DisponÃ­vel" }
          ]
        }
      },
      "layout": {
        "type": "SingleColumnLayout",
        "children": [
          {
            "type": "TextHeading",
            "text": "HorÃ¡rios disponÃ­veis"
          },
          {
            "type": "TextCaption",
            "text": "${data.barber_name}"
          },
          {
            "type": "TextCaption",
            "text": "${data.formatted_date}"
          },
          {
            "type": "TextCaption",
            "text": "â° HorÃ¡rios em tempo real"
          },
          {
            "type": "Form",
            "name": "time_form",
            "children": [
              {
                "type": "RadioButtonsGroup",
                "name": "selected_time",
                "label": "Selecione um horÃ¡rio",
                "required": true,
                "data-source": "${data.available_times}"
              }
            ]
          },
          {
            "type": "Footer",
            "label": "Continuar",
            "on-click-action": {
              "name": "data_exchange",
              "payload": {
                "action_type": "SELECT_TIME",
                "selected_city": "${data.selected_city}",
                "selected_service": "${data.selected_service}",
                "selected_date": "${data.selected_date}",
                "selected_barber": "${data.selected_barber}",
                "selected_time": "${time_form.selected_time}"
              }
            }
          }
        ]
      }
    },
    {
      "id": "DETAILS",
      "title": "Seus Dados",
      "terminal": false,
      "data": {
        "selected_city": {
          "type": "string",
          "__example__": "sao_paulo"
        },
        "selected_service": {
          "type": "string",
          "__example__": "corte_masculino"
        },
        "selected_date": {
          "type": "string",
          "__example__": "2025-01-15"
        },
        "selected_barber": {
          "type": "string",
          "__example__": "joao"
        },
        "selected_time": {
          "type": "string",
          "__example__": "09:00"
        },
        "service_name": {
          "type": "string",
          "__example__": "Corte Masculino"
        },
        "service_price": {
          "type": "string",
          "__example__": "R$ 45"
        },
        "barber_name": {
          "type": "string",
          "__example__": "JoÃ£o Silva"
        },
        "formatted_date": {
          "type": "string",
          "__example__": "15/01/2025"
        },
        "booking_id": {
          "type": "string",
          "__example__": ""
        }
      },
      "layout": {
        "type": "SingleColumnLayout",
        "children": [
          {
            "type": "TextHeading",
            "text": "Quase lÃ¡! Seus dados"
          },
          {
            "type": "TextBody",
            "text": "Resumo do agendamento:"
          },
          {
            "type": "TextCaption",
            "text": "${data.service_name}"
          },
          {
            "type": "TextCaption",
            "text": "${data.service_price}"
          },
          {
            "type": "TextCaption",
            "text": "${data.barber_name}"
          },
          {
            "type": "TextCaption",
            "text": "${data.formatted_date}"
          },
          {
            "type": "TextCaption",
            "text": "${data.selected_time}"
          },
          {
            "type": "Form",
            "name": "details_form",
            "children": [
              {
                "type": "TextInput",
                "name": "client_name",
                "label": "Seu nome completo",
                "required": true,
                "input-type": "text"
              },
              {
                "type": "TextInput",
                "name": "client_phone",
                "label": "WhatsApp para contato",
                "required": true,
                "input-type": "phone"
              },
              {
                "type": "TextInput",
                "name": "client_email",
                "label": "E-mail (opcional)",
                "required": false,
                "input-type": "email"
              },
              {
                "type": "TextArea",
                "name": "notes",
                "label": "ObservaÃ§Ãµes (opcional)",
                "required": false
              }
            ]
          },
          {
            "type": "If",
            "condition": "${data.booking_id}",
            "then": {
              "type": "TextBody",
              "text": "âœ… Dados validados! CÃ³digo: ${data.booking_id}"
            }
          },
          {
            "type": "If",
            "condition": "${data.booking_id}",
            "then": {
              "type": "Footer",
              "label": "Confirmar agendamento",
              "on-click-action": {
                "name": "navigate",
                "next": {
                  "type": "screen",
                  "name": "CONFIRMATION"
                },
                "payload": {
                  "booking_id": "${data.booking_id}",
                  "selected_city": "${data.selected_city}",
                  "selected_service": "${data.selected_service}",
                  "selected_date": "${data.selected_date}",
                  "selected_barber": "${data.selected_barber}",
                  "selected_time": "${data.selected_time}",
                  "client_name": "${details_form.client_name}",
                  "client_phone": "${details_form.client_phone}",
                  "client_email": "${details_form.client_email}",
                  "notes": "${details_form.notes}",
                  "service_name": "${data.service_name}",
                  "service_price": "${data.service_price}",
                  "barber_name": "${data.barber_name}",
                  "formatted_date": "${data.formatted_date}"
                }
              }
            },
            "else": {
              "type": "Footer",
              "label": "Revisar agendamento",
              "on-click-action": {
                "name": "data_exchange",
                "payload": {
                  "action_type": "SUBMIT_DETAILS",
                  "selected_city": "${data.selected_city}",
                  "selected_service": "${data.selected_service}",
                  "selected_date": "${data.selected_date}",
                  "selected_barber": "${data.selected_barber}",
                  "selected_time": "${data.selected_time}",
                  "client_name": "${details_form.client_name}",
                  "client_phone": "${details_form.client_phone}",
                  "client_email": "${details_form.client_email}",
                  "notes": "${details_form.notes}",
                  "service_name": "${data.service_name}",
                  "service_price": "${data.service_price}",
                  "barber_name": "${data.barber_name}",
                  "formatted_date": "${data.formatted_date}"
                }
              }
            }
          }
        ]
      }
    },
    {
      "id": "CONFIRMATION",
      "title": "Detalhes",
      "terminal": true,
      "success": true,
      "data": {
        "booking_id": {
          "type": "string",
          "__example__": "AGD-12345"
        },
        "selected_city": {
          "type": "string",
          "__example__": "sao_paulo"
        },
        "selected_service": {
          "type": "string",
          "__example__": "corte_masculino"
        },
        "selected_date": {
          "type": "string",
          "__example__": "2025-01-15"
        },
        "selected_barber": {
          "type": "string",
          "__example__": "joao"
        },
        "selected_time": {
          "type": "string",
          "__example__": "09:00"
        },
        "client_name": {
          "type": "string",
          "__example__": "JoÃ£o Cliente"
        },
        "client_phone": {
          "type": "string",
          "__example__": "+55 11 99999-9999"
        },
        "client_email": {
          "type": "string",
          "__example__": "cliente@email.com"
        },
        "notes": {
          "type": "string",
          "__example__": ""
        },
        "service_name": {
          "type": "string",
          "__example__": "Corte Masculino"
        },
        "service_price": {
          "type": "string",
          "__example__": "R$ 45"
        },
        "barber_name": {
          "type": "string",
          "__example__": "JoÃ£o Silva"
        },
        "formatted_date": {
          "type": "string",
          "__example__": "15/01/2025 (Quarta-feira)"
        }
      },
      "layout": {
        "type": "SingleColumnLayout",
        "children": [
          {
            "type": "TextHeading",
            "text": "âœ… Agendamento confirmado!"
          },
          {
            "type": "TextSubheading",
            "text": "CÃ³digo: ${data.booking_id}"
          },
          {
            "type": "Form",
            "name": "confirmation_form",
            "children": [
              {
                "type": "TextBody",
                "text": "Seu horÃ¡rio estÃ¡ reservado:"
              },
              {
                "type": "TextBody",
                "text": "ðŸ’ˆ ${data.service_name}"
              },
              {
                "type": "TextBody",
                "text": "âœ‚ï¸ ${data.barber_name}"
              },
              {
                "type": "TextBody",
                "text": "ðŸ“… ${data.formatted_date}"
              },
              {
                "type": "TextBody",
                "text": "ðŸ• ${data.selected_time}"
              },
              {
                "type": "TextBody",
                "text": "ðŸ’° ${data.service_price}"
              },
              {
                "type": "TextBody",
                "text": "ðŸ‘¤ ${data.client_name}"
              },
              {
                "type": "TextCaption",
                "text": "ðŸ“² VocÃª receberÃ¡ confirmaÃ§Ã£o e lembrete"
              },
              {
                "type": "TextCaption",
                "text": "âš ï¸ Para cancelar, informe o cÃ³digo ${data.booking_id}"
              },
              {
                "type": "Footer",
                "label": "Concluir",
                "on-click-action": {
                  "name": "complete",
                  "payload": {
                    "booking_id": "${data.booking_id}",
                    "selected_city": "${data.selected_city}",
                    "selected_service": "${data.selected_service}",
                    "selected_date": "${data.selected_date}",
                    "selected_barber": "${data.selected_barber}",
                    "selected_time": "${data.selected_time}",
                    "client_name": "${data.client_name}",
                    "client_phone": "${data.client_phone}",
                    "client_email": "${data.client_email}",
                    "notes": "${data.notes}",
                    "service_name": "${data.service_name}",
                    "service_price": "${data.service_price}",
                    "barber_name": "${data.barber_name}",
                    "formatted_date": "${data.formatted_date}",
                    "status": "confirmed"
                  }
                }
              }
            ]
          }
        ]
      }
    }
  ]
}